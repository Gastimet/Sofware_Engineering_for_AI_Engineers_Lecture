// Projenizin /PythonProject2/Jenkinsfile yoluna bu dosyayı koyun

pipeline {
    agent any

    // --- YENİ VE ÖNEMLİ BÖLÜM ---
    // Jenkins'e hangi Docker aracını kullanacağını açıkça belirtir.
    // İsim, "Global Tool Configuration" sayfasında verdiğiniz isimle
    // BİREBİR AYNI OLMALIDIR.
    tools {
        dockerTool 'docker-from-host'
    }

    environment {
        PROJECT_DIR       = 'Autogluon_multiple_regression_models'
        DOCKER_IMAGE_NAME = 'autogluon-ml-app'
        DOCKER_IMAGE_TAG  = 'latest'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Kod, Git reposundan çekiliyor...'
                checkout scm
            }
        }

        stage('Build and Train') {
            steps {
                dir(env.PROJECT_DIR) {

                    echo "Dockerfile kullanılarak imaj oluşturuluyor..."
                    def dockerImage = docker.build("${env.DOCKER_IMAGE_NAME}:${env.DOCKER_IMAGE_TAG}", ".")

                    echo 'Model eğitim betiği (train.py) çalıştırılıyor...'
                    dockerImage.inside {
                        sh '''
                        python -m src.pipeline.train \
                            --task churn \
                            --data-csv-a example_data/source_a.csv \
                            --data-csv-b example_data/source_b.csv \
                            --target churned \
                            --join-keys customer_id \
                            --promote
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline tamamlandı.'
            cleanWs()
        }
    }
}