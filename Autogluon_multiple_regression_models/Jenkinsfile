pipeline {
    // 1. Ajan: Herhangi bir uygun Jenkins ajanÄ±
    agent any

    // 2. AraÃ§lar: Jenkins ayarlarÄ±ndaki 'docker-from-host' isimli
    //    Docker aracÄ±nÄ± kullanacaÄŸÄ±mÄ±zÄ± belirtiyoruz.
    tools {
        dockerTool 'docker-from-host'
    }

    // 3. Ortam DeÄŸiÅŸkenleri: Proje klasÃ¶rÃ¼mÃ¼zÃ¼n adÄ±nÄ± tanÄ±mlÄ±yoruz.
    environment {
        // !!! Ã–NEMLÄ°: Bu ismi kendi reponuzdaki klasÃ¶r adÄ±yla deÄŸiÅŸtirin.
        PROJECT_DIR = 'Autogluon_multiple_regression_models'
    }

    stages {
        // 4. AÅŸama: Kodu Git'ten Ã‡ekme
        stage('Checkout Code') {
            steps {
                echo 'ğŸ“¦ Kod, Git reposundan Ã§ekiliyor...'
                checkout scm
            }
        }

        // 5. AÅŸama: ML Pipeline'Ä±nÄ± Ã‡alÄ±ÅŸtÄ±rma
        // Bu aÅŸama, servisleri baÅŸlatÄ±r, eÄŸitimi Ã§alÄ±ÅŸtÄ±rÄ±r ve temizler.
        stage('Run ML Pipeline') {
            steps {
                // Proje klasÃ¶rÃ¼nÃ¼n iÃ§ine giriyoruz
                dir(env.PROJECT_DIR) {
                    script {
                        // try...finally bloÄŸu, eÄŸitim baÅŸarÄ±sÄ±z olsa bile
                        // 'finally' iÃ§indeki temizlik adÄ±mÄ±nÄ±n Ã§alÄ±ÅŸmasÄ±nÄ± garantiler.
                        try {
                            echo "ğŸš€ MLflow servisi baÅŸlatÄ±lÄ±yor..."
                            // DÃœZELTME: 'docker-compose' yerine modern 'docker compose'
                            // (boÅŸluklu) komutunu kullanÄ±yoruz. Bu, Jenkins'in
                            // 'command not found' hatasÄ± vermesini engeller.
                            sh "docker compose up --build -d mlflow"

                            echo "âŒ› MLflow'un saÄŸlÄ±klÄ± olmasÄ± bekleniyor..."
                            // MLflow'un healthcheck'inin baÅŸarÄ±lÄ± olmasÄ±nÄ± bekliyoruz.
                            sh """
                            sleep 15
                            docker inspect --format='{{.State.Health.Status}}' mlflow | grep -q 'healthy' || (
                                echo 'âš ï¸ MLflow henÃ¼z saÄŸlÄ±klÄ± deÄŸil, 20 saniye daha bekleniyor...' &&
                                sleep 20 &&
                                docker inspect --format='{{.State.Health.Status}}' mlflow | grep -q 'healthy'
                            )
                            """

                            echo "ğŸ¤– Model eÄŸitimi baÅŸlatÄ±lÄ±yor..."
                            // DÃœZELTME: 'docker-compose run' yerine Jenkins'in kendi
                            // docker komutunu kullanÄ±yoruz. Bu, 'Network recreate'
                            // hatasÄ±nÄ± tamamen Ã§Ã¶zer.
                            docker.image('python:3.11-slim').inside("--network ${env.PROJECT_DIR}_default") {
                                // Bu blok, 'python:3.11-slim' imajÄ±nda Ã§alÄ±ÅŸÄ±r
                                // ve 'mlflow' konteynerine eriÅŸebilir.

                                echo "ğŸ Gerekli Python kÃ¼tÃ¼phaneleri kuruluyor..."
                                sh "pip install --no-cache-dir -r requirements.txt"

                                echo "ğŸ‘Ÿ EÄŸitim betiÄŸi Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
                                sh '''
                                python -m src.pipeline.train \
                                    --task churn \
                                    --data-csv-a example_data/source_a.csv \
                                    --data-csv-b example_data/source_b.csv \
                                    --target churned \
                                    --join-keys customer_id \
                                    --promote
                                '''
                            }
                        } finally {
                            // 6. Temizlik AdÄ±mÄ±: Her durumda Ã§alÄ±ÅŸÄ±r
                            echo "ğŸ§¹ TÃ¼m servisler kapatÄ±lÄ±yor..."
                            // DÃœZELTME: 'docker-compose' yerine 'docker compose'
                            // ve tÃ¼m verileri silmek iÃ§in '--volumes' eklendi.
                            sh "docker compose down --volumes"
                        }
                    }
                }
            }
        }
    }

    // 7. Post: Pipeline bittikten sonra yapÄ±lacaklar
    post {
        always {
            echo 'âœ… Pipeline tamamlandÄ±.'
            // Jenkins Ã§alÄ±ÅŸma alanÄ±nÄ± temizle
            cleanWs()
        }
        success {
            echo 'ğŸ‰ Pipeline baÅŸarÄ±yla tamamlandÄ±!'
        }
        failure {
            echo 'âŒ Pipeline baÅŸarÄ±sÄ±z oldu!'
        }
    }
}
