pipeline {
    agent any

    // --- CORRECTED SYNTAX IS HERE ---
    // Using 'dockerTool' as you correctly pointed out.
    tools {
        dockerTool 'docker-from-host'
    }

    environment {
        // IMPORTANT: Make sure this matches your folder name in Git.
        PROJECT_DIR       = 'Autogluon_multiple_regression_models'

        DOCKER_IMAGE_NAME = 'autogluon-ml-app'
        DOCKER_IMAGE_TAG  = 'latest'
    }

    stages {
        stage('Checkout Code') {
            steps {
                echo 'Checking out code from Git...'
                checkout scm
            }
        }

        stage('Build and Train') {
            steps {
                dir(env.PROJECT_DIR) {
                    script {
                        echo "Building Docker image..."
                        // The 'docker' variable is still used here, which is correct.
                        // The 'tools' block above just sets the environment path.
                        def dockerImage = docker.build("${env.DOCKER_IMAGE_NAME}:${env.DOCKER_IMAGE_TAG}", ".")

                        echo 'Starting model training inside the container...'
                        dockerImage.inside {
                            sh '''
                            python -m src.pipeline.train \
                                --task churn \
                                --data-csv-a example_data/source_a.csv \
                                --data-csv-b example_data/source_b.csv \
                                --target churned \
                                --join-keys customer_id \
                                --promote
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
            cleanWs()
        }
    }
}